<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OfficeVisitController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iTrust</a> &gt; <a href="index.source.html" class="el_package">edu.ncsu.csc.itrust.controller.officeVisit</a> &gt; <span class="el_source">OfficeVisitController.java</span></div><h1>OfficeVisitController.java</h1><pre class="source lang-java linenums">package edu.ncsu.csc.itrust.controller.officeVisit;

import java.io.IOException;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.temporal.ChronoUnit;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

import javax.faces.application.FacesMessage;
import javax.faces.application.FacesMessage.Severity;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.SessionScoped;
import javax.faces.context.FacesContext;
import javax.sql.DataSource;

import edu.ncsu.csc.itrust.controller.NavigationController;
import edu.ncsu.csc.itrust.controller.iTrustController;
import edu.ncsu.csc.itrust.exception.DBException;
import edu.ncsu.csc.itrust.model.ValidationFormat;
import edu.ncsu.csc.itrust.model.officeVisit.OfficeVisit;
import edu.ncsu.csc.itrust.model.officeVisit.OfficeVisitData;
import edu.ncsu.csc.itrust.model.officeVisit.OfficeVisitMySQL;
import edu.ncsu.csc.itrust.model.old.enums.TransactionType;
import edu.ncsu.csc.itrust.webutils.SessionUtils;

@ManagedBean(name = &quot;office_visit_controller&quot;)
@SessionScoped
public class OfficeVisitController extends iTrustController {

	/**
	 * The cut off age for being considered a baby.
	 */
	private static final int PATIENT_BABY_AGE = 3;

	/**
	 * The cut off age for being considered a child.
	 */
	private static final int PATIENT_CHILD_AGE = 12;

	/**
	 * Constant for the error message to be displayed if the Office Visit is
	 * invalid.
	 */
	private static final String OFFICE_VISIT_CANNOT_BE_UPDATED = &quot;Invalid Office Visit&quot;;

	/**
	 * Constant for the message to be displayed if the office visit was
	 * unsuccessfully updated
	 */
	private static final String OFFICE_VISIT_CANNOT_BE_CREATED = &quot;Office Visit Cannot Be Updated&quot;;

	/**
	 * Constant for the message to be displayed if the office visit was
	 * successfully created
	 */
	private static final String OFFICE_VISIT_SUCCESSFULLY_CREATED = &quot;Office Visit Successfully Created&quot;;

	/**
	 * Constant for the message to be displayed if the office visit was
	 * successfully updated
	 */
	private static final String OFFICE_VISIT_SUCCESSFULLY_UPDATED = &quot;Office Visit Successfully Updated&quot;;

	private OfficeVisitData officeVisitData;
	private SessionUtils sessionUtils;

<span class="nc" id="L69">	public OfficeVisitController() throws DBException {</span>
<span class="nc" id="L70">		officeVisitData = new OfficeVisitMySQL();</span>
<span class="nc" id="L71">		sessionUtils = SessionUtils.getInstance();</span>
<span class="nc" id="L72">	}</span>

	/**
	 * For testing purposes
	 * 
	 * @param ds
	 *            DataSource
	 * @param sessionUtils
	 *            SessionUtils instance
	 */
<span class="fc" id="L82">	public OfficeVisitController(DataSource ds, SessionUtils sessionUtils) {</span>
<span class="fc" id="L83">		officeVisitData = new OfficeVisitMySQL(ds);</span>
<span class="fc" id="L84">		this.sessionUtils = sessionUtils;</span>
<span class="fc" id="L85">	}</span>

	/**
	 * For testing purposes
	 * 
	 * @param ds
	 *            DataSource
	 */
<span class="fc" id="L93">	public OfficeVisitController(DataSource ds) {</span>
<span class="fc" id="L94">		officeVisitData = new OfficeVisitMySQL(ds);</span>
<span class="fc" id="L95">		sessionUtils = SessionUtils.getInstance();</span>
<span class="fc" id="L96">	}</span>

	/**
	 * Adding office visit used in testing.
	 * 
	 * @param ov
	 *            Office visit
	 * @return true if successfully added, false if otherwise
	 */
	public boolean addReturnResult(OfficeVisit ov) {
<span class="fc" id="L106">		boolean res = false;</span>

		try {
<span class="fc" id="L109">			res = officeVisitData.add(ov);</span>
<span class="fc" id="L110">		} catch (Exception e) {</span>
			// do nothing
<span class="fc" id="L112">		}</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">		if (res) {</span>
<span class="fc" id="L114">			logEditBasicHealthInformation();</span>
		}

<span class="fc" id="L117">		return res;</span>
	}

	/**
	 * Add office visit to the database and return the generated VisitID.
	 * 
	 * @param ov
	 *            Office visit to add to the database
	 * @return VisitID generated from the database insertion, -1 if nothing was
	 *         generated
	 * @throws DBException
	 *             if error occurred in inserting office visit
	 */
	public long addReturnGeneratedId(OfficeVisit ov) {
<span class="fc" id="L131">		long generatedId = -1;</span>

		try {
<span class="fc" id="L134">			generatedId = officeVisitData.addReturnGeneratedId(ov);</span>
<span class="nc" id="L135">		} catch (DBException e) {</span>
<span class="nc" id="L136">			printFacesMessage(FacesMessage.SEVERITY_INFO, OFFICE_VISIT_CANNOT_BE_CREATED, e.getExtendedMessage(), null);</span>
<span class="nc" id="L137">		} catch (Exception e) {</span>
<span class="nc" id="L138">			printFacesMessage(FacesMessage.SEVERITY_INFO, OFFICE_VISIT_CANNOT_BE_CREATED,</span>
					OFFICE_VISIT_CANNOT_BE_CREATED, null);
<span class="pc" id="L140">		}</span>

<span class="pc bpc" id="L142" title="1 of 2 branches missed.">		if (generatedId &gt;= 0) {</span>
<span class="fc" id="L143">			printFacesMessage(FacesMessage.SEVERITY_INFO, OFFICE_VISIT_SUCCESSFULLY_CREATED,</span>
					OFFICE_VISIT_SUCCESSFULLY_CREATED, null);
<span class="fc" id="L145">			logEditBasicHealthInformation();</span>
		}

<span class="fc" id="L148">		return generatedId;</span>
	}

	/**
	 * Sends a FacesMessage for FacesContext to display.
	 * 
	 * @param severity
	 *            severity of the message
	 * @param summary
	 *            localized summary message text
	 * @param detail
	 *            localized detail message text
	 * @param clientId
	 *            The client identifier with which this message is associated
	 *            (if any)
	 */
	public void printFacesMessage(Severity severity, String summary, String detail, String clientId) {
<span class="fc" id="L165">		FacesContext ctx = FacesContext.getCurrentInstance();</span>
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">		if (ctx == null) {</span>
<span class="fc" id="L167">			return;</span>
		}
<span class="nc" id="L169">		ctx.getExternalContext().getFlash().setKeepMessages(true);</span>
<span class="nc" id="L170">		ctx.addMessage(clientId, new FacesMessage(severity, summary, detail));</span>
<span class="nc" id="L171">	}</span>

	public void redirectToBaseOfficeVisit() throws IOException {
<span class="nc bnc" id="L174" title="All 2 branches missed.">		if (FacesContext.getCurrentInstance() != null) {</span>
<span class="nc" id="L175">			NavigationController.baseOfficeVisit();</span>
		}
<span class="nc" id="L177">	}</span>

	public void add(OfficeVisit ov) {
<span class="fc" id="L180">		boolean res = false;</span>

		try {
<span class="fc" id="L183">			res = officeVisitData.add(ov);</span>
<span class="fc" id="L184">		} catch (DBException e) {</span>
<span class="fc" id="L185">			printFacesMessage(FacesMessage.SEVERITY_ERROR, OFFICE_VISIT_CANNOT_BE_CREATED, e.getExtendedMessage(),</span>
					null);
<span class="nc" id="L187">		} catch (Exception e) {</span>
<span class="nc" id="L188">			printFacesMessage(FacesMessage.SEVERITY_ERROR, OFFICE_VISIT_CANNOT_BE_CREATED,</span>
					OFFICE_VISIT_CANNOT_BE_CREATED, null);
<span class="fc" id="L190">		}</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">		if (res) {</span>
<span class="fc" id="L192">			printFacesMessage(FacesMessage.SEVERITY_INFO, OFFICE_VISIT_SUCCESSFULLY_CREATED,</span>
					OFFICE_VISIT_SUCCESSFULLY_CREATED, null);
<span class="fc" id="L194">			logEditBasicHealthInformation();</span>
		}
<span class="fc" id="L196">	}</span>

	/**
	 * @param pid
	 *            patient mid
	 * @return sorted list of office visit for the given patient
	 */
	public List&lt;OfficeVisit&gt; getOfficeVisitsForPatient(String pid) {
<span class="fc" id="L204">		List&lt;OfficeVisit&gt; ret = Collections.emptyList();</span>
<span class="fc" id="L205">		long mid = -1;</span>
<span class="fc bfc" id="L206" title="All 4 branches covered.">		if ((pid != null) &amp;&amp; ValidationFormat.NPMID.getRegex().matcher(pid).matches()) {</span>
<span class="fc" id="L207">			mid = Long.parseLong(pid);</span>
			try {
<span class="fc" id="L209">				ret = officeVisitData.getVisitsForPatient(mid).stream().sorted((o1, o2) -&gt; {</span>
<span class="fc" id="L210">					return o2.getDate().compareTo(o1.getDate());</span>
<span class="fc" id="L211">				}).collect(Collectors.toList());</span>
<span class="fc" id="L212">			} catch (Exception e) {</span>
<span class="fc" id="L213">				printFacesMessage(FacesMessage.SEVERITY_ERROR, &quot;Unable to Retrieve Office Visits&quot;,</span>
						&quot;Unable to Retrieve Office Visits&quot;, null);
<span class="fc" id="L215">			}</span>
		}
<span class="fc" id="L217">		return ret;</span>
	}

	/**
	 * @return list of office visit sorted by date, empty list if no office
	 *         visit exists
	 */
	public List&lt;OfficeVisit&gt; getOfficeVisitsForCurrentPatient() {
<span class="fc" id="L225">		return getOfficeVisitsForPatient(sessionUtils.getCurrentPatientMID());</span>
	}

	/**
	 * @param pid
	 *            patient mid
	 * @return list of office visits when given patient was a baby, empty list
	 *         if no office visit exists during that age range
	 */
	public List&lt;OfficeVisit&gt; getBabyOfficeVisitsForPatient(String pid) {
<span class="fc" id="L235">		return getOfficeVisitsForPatient(pid).stream().filter((o) -&gt; {</span>
<span class="fc" id="L236">			return isPatientABaby(o.getPatientMID(), o.getDate());</span>
<span class="fc" id="L237">		}).collect(Collectors.toList());</span>
	}

	/**
	 * @return list of office visits when current patient was a baby, empty list
	 *         if no office visit exists during that age range
	 */
	public List&lt;OfficeVisit&gt; getBabyOfficeVisitsForCurrentPatient() {
<span class="fc" id="L245">		return getBabyOfficeVisitsForPatient(sessionUtils.getCurrentPatientMID());</span>
	}

	/**
	 * @param pid
	 *            patient mid
	 * @return list of office visits when given patient was a child, empty list
	 *         if no office visit exists during that age range
	 */
	public List&lt;OfficeVisit&gt; getChildOfficeVisitsForPatient(String pid) {
<span class="fc" id="L255">		return getOfficeVisitsForPatient(pid).stream().filter((o) -&gt; {</span>
<span class="fc" id="L256">			return isPatientAChild(o.getPatientMID(), o.getDate());</span>
<span class="fc" id="L257">		}).collect(Collectors.toList());</span>
	}

	/**
	 * @return list of office visits when current patient was a child, empty
	 *         list if no office visit exists during that age range
	 */
	public List&lt;OfficeVisit&gt; getChildOfficeVisitsForCurrentPatient() {
<span class="fc" id="L265">		return getChildOfficeVisitsForPatient(sessionUtils.getCurrentPatientMID());</span>
	}

	/**
	 * @param pid
	 *            patient mid
	 * @return list of office visits when given patient was an adult, empty list
	 *         if no office visit exists during that age range
	 */
	public List&lt;OfficeVisit&gt; getAdultOfficeVisitsForPatient(String pid) {
<span class="fc" id="L275">		return getOfficeVisitsForPatient(pid).stream().filter((o) -&gt; {</span>
<span class="fc" id="L276">			return isPatientAnAdult(o.getPatientMID(), o.getDate());</span>
<span class="fc" id="L277">		}).collect(Collectors.toList());</span>
	}

	/**
	 * @return list of office visits when current patient was an adult, empty
	 *         list if no office visit exists during that age range
	 */
	public List&lt;OfficeVisit&gt; getAdultOfficeVisitsForCurrentPatient() {
<span class="fc" id="L285">		return getAdultOfficeVisitsForPatient(sessionUtils.getCurrentPatientMID());</span>
	}

	public OfficeVisit getVisitByID(String VisitID) {
<span class="fc" id="L289">		long id = -1;</span>
		try {
<span class="fc" id="L291">			id = Long.parseLong(VisitID);</span>
<span class="fc" id="L292">		} catch (NumberFormatException ne) {</span>
<span class="fc" id="L293">			printFacesMessage(FacesMessage.SEVERITY_ERROR, &quot;Unable to Retrieve Office Visit&quot;,</span>
					&quot;Unable to Retrieve Office Visit&quot;, null);
<span class="fc" id="L295">			return null;</span>
<span class="fc" id="L296">		}</span>
		try {
<span class="fc" id="L298">			return officeVisitData.getByID(id);</span>
<span class="nc" id="L299">		} catch (Exception e) {</span>
<span class="nc" id="L300">			printFacesMessage(FacesMessage.SEVERITY_ERROR, &quot;Unable to Retrieve Office Visit&quot;,</span>
					&quot;Unable to Retrieve Office Visit&quot;, null);
<span class="nc" id="L302">			return null;</span>
		}
	}

	/**
	 * @return Office Visit of the selected patient in the HCP session
	 */
	public OfficeVisit getSelectedVisit() {
<span class="fc" id="L310">		String visitID = sessionUtils.getRequestParameter(&quot;visitID&quot;);</span>
<span class="pc bpc" id="L311" title="1 of 4 branches missed.">		if (visitID == null || visitID.isEmpty()) {</span>
<span class="fc" id="L312">			return null;</span>
		}
<span class="fc" id="L314">		return getVisitByID(visitID);</span>
	}

	/**
	 * @param patientID
	 *            Patient MID
	 * @return true if selected patient MID has at least 1 office visit, false
	 *         otherwise
	 */
	public boolean hasPatientVisited(String patientID) {
<span class="fc" id="L324">		boolean ret = false;</span>
<span class="fc bfc" id="L325" title="All 4 branches covered.">		if ((patientID != null) &amp;&amp; (ValidationFormat.NPMID.getRegex().matcher(patientID).matches())) {</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">			if (getOfficeVisitsForPatient(patientID).size() &gt; 0) {</span>
<span class="fc" id="L327">				ret = true;</span>
			}
		}
<span class="fc" id="L330">		return ret;</span>
	}

	/**
	 * @return true if patient selected in HCP session has at least 1 office
	 *         visit, false if otherwise
	 */
	public boolean CurrentPatientHasVisited() {
<span class="fc" id="L338">		return hasPatientVisited(sessionUtils.getCurrentPatientMID());</span>
	}

	public void edit(OfficeVisit ov) {
<span class="fc" id="L342">		boolean res = false;</span>

		try {
<span class="fc" id="L345">			res = officeVisitData.update(ov);</span>
<span class="nc" id="L346">		} catch (DBException e) {</span>
<span class="nc" id="L347">			printFacesMessage(FacesMessage.SEVERITY_ERROR, OFFICE_VISIT_CANNOT_BE_UPDATED, e.getExtendedMessage(),</span>
					null);
<span class="nc" id="L349">		} catch (Exception e) {</span>
<span class="nc" id="L350">			printFacesMessage(FacesMessage.SEVERITY_ERROR, OFFICE_VISIT_CANNOT_BE_UPDATED,</span>
					OFFICE_VISIT_CANNOT_BE_UPDATED, null);
<span class="pc" id="L352">		}</span>
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">		if (res) {</span>
<span class="fc" id="L354">			printFacesMessage(FacesMessage.SEVERITY_INFO, OFFICE_VISIT_SUCCESSFULLY_UPDATED,</span>
					OFFICE_VISIT_SUCCESSFULLY_UPDATED, null);
<span class="fc" id="L356">			logEditBasicHealthInformation();</span>
		}
<span class="fc" id="L358">	}</span>

	/**
	 * Calculate given patient's age given a day in the future.
	 * 
	 * @param patientMID
	 *            MID of the patient
	 * @param futureDate
	 *            Date in the future
	 * @return patient's age in calendar year, or -1 if error occurred
	 */
	public Long calculatePatientAge(final Long patientMID, final LocalDateTime futureDate) {
<span class="fc" id="L370">		Long ret = -1L;</span>
<span class="fc bfc" id="L371" title="All 4 branches covered.">		if (futureDate == null || patientMID == null) {</span>
<span class="fc" id="L372">			return ret;</span>
		}

<span class="fc" id="L375">		LocalDate patientDOB = getPatientDOB(patientMID);</span>
<span class="fc bfc" id="L376" title="All 2 branches covered.">		if (patientDOB == null) {</span>
<span class="fc" id="L377">			return ret;</span>
		}

<span class="fc bfc" id="L380" title="All 2 branches covered.">		if (futureDate.toLocalDate().isBefore(patientDOB)) {</span>
<span class="fc" id="L381">			return ret;</span>
		}

<span class="fc" id="L384">		return ChronoUnit.YEARS.between(patientDOB, futureDate);</span>
	}

	/**
	 * Check whether patient is under 3 years of age.
	 * 
	 * @param patientMID
	 *            MID of the patient
	 * @param officeVisitDate
	 *            date of the office visit
	 * @return true if patient is under 3 years old at the time of the office
	 *         visit, false if otherwise
	 */
	public boolean isPatientABaby(final Long patientMID, final LocalDateTime officeVisitDate) {
<span class="fc" id="L398">		Long age = calculatePatientAge(patientMID, officeVisitDate);</span>
<span class="fc bfc" id="L399" title="All 4 branches covered.">		return age &lt; PATIENT_BABY_AGE &amp;&amp; age &gt;= 0;</span>
	}

	/**
	 * Check whether patient is between 3 years (inclusive) and 12 years
	 * (exclusive) old.
	 * 
	 * @param patientMID
	 *            MID of the patient
	 * @param officeVisitDate
	 *            date of the office visit
	 * @return true if patient is is between 3 years (inclusive) and 12 years
	 *         (exclusive) old, false if otherwise
	 */
	public boolean isPatientAChild(final Long patientMID, final LocalDateTime officeVisitDate) {
<span class="fc" id="L414">		Long age = calculatePatientAge(patientMID, officeVisitDate);</span>
<span class="fc bfc" id="L415" title="All 4 branches covered.">		return age &lt; PATIENT_CHILD_AGE &amp;&amp; age &gt;= PATIENT_BABY_AGE;</span>
	}

	/**
	 * Check whether patient is between 12 years old or older.
	 * 
	 * @param patientMID
	 *            MID of the patient
	 * @param officeVisitDate
	 *            date of the office visit
	 * @return true if patient is is 12 years old or older, false if otherwise
	 */
	public boolean isPatientAnAdult(final Long patientMID, final LocalDateTime officeVisitDate) {
<span class="fc" id="L428">		Long age = calculatePatientAge(patientMID, officeVisitDate);</span>
<span class="fc bfc" id="L429" title="All 2 branches covered.">		return age &gt;= PATIENT_CHILD_AGE;</span>
	}

	/**
	 * @param patientMID
	 *            The patient's MID
	 * @return the patient's date of birth
	 */
	public LocalDate getPatientDOB(final Long patientMID) {
<span class="fc" id="L438">		return officeVisitData.getPatientDOB(patientMID);</span>
	}

	/**
	 * Logs that the currently selected office visit has been viewed (if any
	 * office visit is selected)
	 */
	public void logViewOfficeVisit() {
<span class="fc" id="L446">		Long id = getSessionUtils().getCurrentOfficeVisitId();</span>
<span class="fc bfc" id="L447" title="All 2 branches covered.">		if (id != null) {</span>
<span class="fc" id="L448">			logTransaction(TransactionType.OFFICE_VISIT_VIEW, id.toString());</span>
<span class="fc" id="L449">			OfficeVisit ov = getVisitByID(Long.toString(id));</span>
<span class="fc" id="L450">			long patientMID = ov.getPatientMID();</span>
<span class="fc" id="L451">			LocalDateTime d = ov.getDate();</span>
<span class="fc" id="L452">			logTransaction(TransactionType.VIEW_BASIC_HEALTH_METRICS, &quot;Age: &quot; + calculatePatientAge(patientMID, d));</span>
		}
<span class="fc" id="L454">	}</span>
	
	/**
	 * Logs that the current user viewed a patient's health metrics page
	 */
	public void logViewHealthMetrics(){
<span class="nc" id="L460">	    String role = sessionUtils.getSessionUserRole();</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">	    if (&quot;hcp&quot;.equals(role)){</span>
<span class="nc" id="L462">	        logTransaction(TransactionType.HCP_VIEW_BASIC_HEALTH_METRICS, &quot;&quot;);</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">	    } else if (&quot;patient&quot;.equals(role)){</span>
<span class="nc" id="L464">	        logTransaction(TransactionType.PATIENT_VIEW_BASIC_HEALTH_METRICS, Long.parseLong(sessionUtils.getSessionLoggedInMID()), null, &quot;&quot;);</span>
	    }
<span class="nc" id="L466">	}</span>
	
	public void logViewBasicHealthInformation() {
<span class="nc" id="L469">		logTransaction(TransactionType.PATIENT_HEALTH_INFORMATION_VIEW, &quot;&quot;);</span>
<span class="nc" id="L470">	}</span>

	/**
	 * Editing basic health information is synonymous with editing or adding an
	 * office visit, so this method should be called whenever an OV is
	 * added/edited.
	 */
	private void logEditBasicHealthInformation() {
<span class="fc" id="L478">		logTransaction(TransactionType.PATIENT_HEALTH_INFORMATION_EDIT, &quot;&quot;);</span>
<span class="fc" id="L479">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>